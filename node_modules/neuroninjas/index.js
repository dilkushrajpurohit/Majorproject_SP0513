
const http=require('http');
const fs=require('fs');
const path = require('path');


function neuroninjas(){// constrcutor mai joh hi store karna ho use banate hai this. karke taaki baad mai use kar sake
    this.routes=[];
    this.middlewares=[];

    };

    neuroninjas.prototype.get=function(path,handler){
        let route={
            method:'GET',
            path:path,
            handler:handler
        }
        this.routes.push(route)
    };

    neuroninjas.prototype.use=function(middleware){
        this.middlewares.push(middleware)
    };

    neuroninjas.prototype.post=function(Path,handler){
        let route={
            method:'POST',   
            path:Path,
            handler:handler}
        this.routes.push(route)
    };

    neuroninjas.prototype.listen=function(port,call){
        const server=http.createServer((req,res)=>{
            this.routes.find(route=>route.method===req.method && route.path===req.url)
                const route=this.routes.find(route=>route.method===req.method && route.path===req.url);
                
            let i=0;
            const next=()=>{ 

                if(i<this.middlewares.length){
                    this.middlewares[i++](req,new response(res),next);// post increment hai 
                }
                else{
                    if(route){
                        route.handler(req,new response(res))
                    }
                    
                    let f=this.routes.find(route=>route.method===req.method && route.path.includes(':'))
                    if(f){
                        let urlpart=req.url.split("/")
                        let routepart=f.path.split("/")
                        if(urlpart.length===routepart.length){
                            let params={}
                            for(let i=0;i<routepart.length;i++){
                                if(routepart[i].startsWith(":")){
                                    let key=routepart[i].slice(1)
                                    params[key]=urlpart[i]
                                    req.params=params
                                    f.handler(req,new response(res))
                                    

                                }
                                else if(routepart[i]!==urlpart[i]){
                                    break

                                
                            }
                        }
                    }   }
                    else{
                        res.writeHead(404);
                        res.end('not found')
                    }
                }
            }

    next();
                
        })
        server.listen(port,call);
    };
    





function response(res){
    this.res=res;
}
response.prototype.send=function(data){
        this.res.end(data);

    }
    response.prototype.json=function(data){
        this.res.setHeader('Content-Type','application/json');
        this.res.end(JSON.stringify(data)); // it is used to convert a javascript object into a json string

    }
    response.prototype.render=function(view){
        const filename=path.join(__dirname,view+'.html');
        fs.readFile(filename,(err,data)=>{
            if(err){
                this.res.writeHead(500);
                this.res.end("Internal Server Error");
            }
            else{
                this.res.setHeader('Content-Type','text/html');
                this.res.end(data);
            }   
    }
    )}
let dilkush =new neuroninjas();


dilkush.use((req,res,next)=>{
    console.log("middleware 1")
    next()
})

dilkush.get('/',(req,res)=>{
    res.send('hello')
})
dilkush.get('/about',(req,res)=>{
    res.render("index")
})
dilkush.get("/user/:id",(req,res)=>{
    res.send('user id'+req.params.id)
})
dilkush.listen(3000,()=>{
    console.log('server is running at port 3000')
})


