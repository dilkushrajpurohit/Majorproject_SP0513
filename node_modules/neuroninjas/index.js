const http = require('http');
const fs = require('fs');
const path = require('path');

function neuroninjas(){
    this.routes = [];
    this.middlewares = [];

    // ðŸ”¥ Rate limiter storage
    this.rateLimitConfig = null;
    this.ipStore = {};
    this.staticFolder = null;
}

// ================= ROUTES =================
neuroninjas.prototype.static = function(folderName){
    this.staticFolder = path.join(__dirname, folderName);
};


neuroninjas.prototype.get = function(path, handler){
    this.routes.push({
        method: 'GET',
        path: path,
        handler: handler
    });
};

neuroninjas.prototype.post = function(path, handler){
    this.routes.push({
        method: 'POST',
        path: path,
        handler: handler
    });
};

neuroninjas.prototype.use = function(middleware){
    this.middlewares.push(middleware);
};

// ================= RATE LIMIT =================

neuroninjas.prototype.rateLimit = function(options){
    this.rateLimitConfig = options;
};

// ================= SERVER =================

neuroninjas.prototype.listen = function(port, callback){

    const server = http.createServer((req, res) => {

        // ðŸ”¥ STATIC FILE HANDLER
if(this.staticFolder){

    const filePath = path.join(this.staticFolder, req.url);

    if(filePath.startsWith(this.staticFolder)){ // security check

        fs.stat(filePath, (err, stats)=>{
            if(!err && stats.isFile()){

                const ext = path.extname(filePath);

                const contentTypes = {
                    ".html":"text/html",
                    ".css":"text/css",
                    ".js":"application/javascript",
                    ".json":"application/json",
                    ".png":"image/png",
                    ".jpg":"image/jpeg",
                    ".jpeg":"image/jpeg",
                    ".gif":"image/gif",
                    ".svg":"image/svg+xml"
                };

                res.writeHead(200, {
                    "Content-Type": contentTypes[ext] || "application/octet-stream"
                });

                fs.createReadStream(filePath).pipe(res);
            }
        });
    }
}

        // ðŸ”¥ RATE LIMITER START
        if(this.rateLimitConfig){

            const ip = req.socket.remoteAddress;
            const now = Date.now();
            const windowTime = this.rateLimitConfig.window;
            const maxRequests = this.rateLimitConfig.max;

            if(!this.ipStore[ip]){
                this.ipStore[ip] = [];
            }

            // Remove expired timestamps
            this.ipStore[ip] = this.ipStore[ip].filter(
                timestamp => now - timestamp < windowTime
            );

            if(this.ipStore[ip].length >= maxRequests){
                res.writeHead(429, {'Content-Type':'text/plain'});
                return res.end("429 Too Many Requests");
            }

            this.ipStore[ip].push(now);
        }
        // ðŸ”¥ RATE LIMITER END


        const route = this.routes.find(
            r => r.method === req.method && r.path === req.url
        );

        let i = 0;

        const next = () => {

            if(i < this.middlewares.length){
                this.middlewares[i++](req, new response(res), next);
            }
            else{

                // Exact route match
                if(route){
                    return route.handler(req, new response(res));
                }

                // Dynamic route match
                const dynamicRoute = this.routes.find(
                    r => r.method === req.method && r.path.includes(':')
                );

                if(dynamicRoute){

                    const urlParts = req.url.split('/');
                    const routeParts = dynamicRoute.path.split('/');

                    if(urlParts.length === routeParts.length){

                        let params = {};
                        let matched = true;

                        for(let j=0; j<routeParts.length; j++){

                            if(routeParts[j].startsWith(':')){
                                const key = routeParts[j].slice(1);
                                params[key] = urlParts[j];
                            }
                            else if(routeParts[j] !== urlParts[j]){
                                matched = false;
                                break;
                            }
                        }

                        if(matched){
                            req.params = params;
                            return dynamicRoute.handler(req, new response(res));
                        }
                    }
                }

                // 404
                res.writeHead(404);
                res.end("Not Found");
            }
        };

        next();

    });

    server.listen(port, callback);
};


// ================= RESPONSE OBJECT =================

function response(res){
    this.res = res;
}

response.prototype.send = function(data){
    this.res.end(data);
};

response.prototype.json = function(data){
    this.res.setHeader('Content-Type','application/json');
    this.res.end(JSON.stringify(data));
};

response.prototype.render = function(view){
    const filename = path.join(__dirname, view + '.html');

    fs.readFile(filename, (err, data)=>{
        if(err){
            this.res.writeHead(500);
            this.res.end("Internal Server Error");
        }
        else{
            this.res.setHeader('Content-Type','text/html');
            this.res.end(data);
        }
    });
};


// =================== APP USAGE ===================

let dilkush = new neuroninjas();

// ðŸ”¥ Enable Rate Limiter
dilkush.rateLimit({
    window: 60000,  // 1 minute
    max: 5          // max 5 requests per IP
});

dilkush.use((req,res,next)=>{
    console.log("middleware 1");
    next();
});

dilkush.get('/', (req,res)=>{
    res.send('hello');
});

dilkush.get('/about', (req,res)=>{
    res.render("index");
});

dilkush.get('/user/:id', (req,res)=>{
    res.send('user id ' + req.params.id);
});

dilkush.listen(3000, ()=>{
    console.log('Server running at http://localhost:3000');
});